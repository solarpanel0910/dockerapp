# Docker Compose（ドッカーコンポーズ）という、複数のプログラムをまとめて動かすための指示書です
version: "3.8"

services:
  # ① データベース（MySQL）の設定です
  db:
    # MySQLの公式イメージを使います
    image: mysql:8.0
    # 日本語を正しく扱うための特別な設定を付け加えます
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    # 接続に必要な「秘密の合言葉」や「名前」を決めます
    environment:
      MYSQL_ROOT_PASSWORD: rootpass # 管理者のパスワード
      MYSQL_DATABASE: votedb        # データベースの名前
    volumes:
      # 手元にある「init.sql（初期化命令）」をデータベースに読み込ませます
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      # データを保存するための場所を確保します
      - db_data:/var/lib/mysql
    networks:
      - vote-net

  # ② Pythonプログラム（app）の設定です
  app:
    # 手元にある「app」フォルダの中身を使って、プログラムを組み立てます
    build: ./app
    # データベースが準備できるまで待ちます
    depends_on:
      - db
    # データベースに接続するために必要な情報を伝えます
    environment:
      DB_HOST: "db"
      DB_USER: "root"
      DB_PASSWORD: "rootpass"
      DB_NAME: "votedb"
    networks:
      - vote-net

  # ③ ウェブサーバー（Nginx / web）の設定です
  web:
    # Nginx（エンジンエックス）という軽量なウェブサーバーを使います
    image: nginx:alpine
    # パソコンの「8888番」から、ウェブサーバーの「80番」へ繋ぎます
    ports:
      - "8888:80"
    volumes:
      # 設定ファイルとHTMLファイルを読み込ませます
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./html:/usr/share/nginx/html:ro
    networks:
      - vote-net
    # Pythonプログラムが動いてから、このサーバーを動かします
    depends_on:
      - app

# 通信の通り道（ネットワーク）の名前を決めます
networks:
  vote-net:
    driver: bridge

# データを保存する場所（ボリューム）の名前を決めます
volumes:
  db_data:
