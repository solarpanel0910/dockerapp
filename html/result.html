<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>投票結果</title>
  <!-- グラフを表示するためのライブラリ（Chart.js）を読み込みます -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* 全体の文字の種類や位置を決めます */
    body {
      font-family: sans-serif;
      text-align: center;
    }

    /* グラフを表示する箱の大きさを決めます */
    .chart-container {
      width: 80%;
      margin: auto;
    }
  </style>
</head>

<body>
  <!-- 投票画面に戻るためのリンクです -->
  <a href="/">👈 投票画面に戻る</a>
  <h1>投票結果</h1>

  <!-- グラフを描くための土台（キャンバス）です -->
  <div class="chart-container">
    <canvas id="voteChart"></canvas>
  </div>

  <script>
    // グラフの情報を保存しておく変数です
    let myChart = null;

    // グラフを新しくしたり、更新したりするための「関数」です
    async function updateChart() {
      // サーバーから「投票データ」を受け取ります
      const response = await fetch("/api/votes");
      const data_list = await response.json();

      // グラフに使う「メニュー名」を入れるための、空の配列を作ります
      const names = [];
      // グラフに使う「得票数」を入れるための、空の配列を作ります
      const counts = [];

      // データの数だけ、1つずつ処理を繰り返します（標準的なforループ）
      for (let i = 0; i < data_list.length; i = i + 1) {
        // 現在のメニューのデータを取り出します
        const item = data_list[i];
        // 配列「names」の最後に、メニュー名を追加します
        names.push(item.name);
        // 配列「counts」の最後に、得票数を追加します
        counts.push(item.count);
      }

      // グラフを描く場所（ctx）を探します
      const ctx = document.getElementById("voteChart").getContext("2d");

      // まだグラフが作られていない場合の処理です
      if (myChart === null) {
        // 新しく棒グラフ（bar）を作ります
        myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: names, // X軸（横）の名前
            datasets: [{
              label: "投票数", // 凡例の名前
              data: counts    // Y軸（縦）の数字
            }]
          }
        });
      } else {
        // すでにグラフがある場合は、中身のデータだけを入れ替えます
        myChart.data.labels = names;
        myChart.data.datasets[0].data = counts;
        // 画面に反映（更新）させます
        myChart.update();
      }
    }

    // ページを開いた時に、まず1回グラフを表示します
    updateChart();

    // 3秒（3000ミリ秒）ごとに、グラフを自動で新しくします
    setInterval(updateChart, 3000);
  </script>
</body>

</html>